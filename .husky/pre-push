#!/bin/bash
set -e
trap 'echo "$(date +"%Y-%m-%d %H:%M:%S") - An error occurred. Exiting script."; exit 1' ERR

# Utility functions
log() {
  echo "$(date +"%Y-%m-%d %H:%M:%S") - $1"
}

get_last_commit_message() {
  git log -1 --pretty=%B
}

has_uncommitted_changes() {
  [[ -n "$(git status --porcelain)" ]]
}

is_chore_commit() {
  local last_commit_message=$(get_last_commit_message)
  [[ "$last_commit_message" == chore:* ]]
}

build_dist() {
  log "Building dist folder..."
  pnpm build
  log "Build completed."
}

version_bump() {
  if has_uncommitted_changes; then
    log "Uncommitted changes detected. Skipping version bump."
    return
  fi

  log "Bumping version..."
  pnpm run ci:version-patch
  log "Version bumped successfully."
}

push_changes() {
  log "Staging and pushing changes..."
  git add package.json
  git add dist

  if has_uncommitted_changes; then
    git commit -m "chore: update dist [auto-generated]"
    git push
  else
    log "No changes to push."
  fi
}

# Main execution
log "Starting pre-push hook..."

if is_chore_commit; then
  log "Detected chore commit. Skipping hook."
  exit 0
fi

build_dist
version_bump
push_changes

log "Pre-push hook completed successfully."